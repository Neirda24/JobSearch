{% extends 'AppBundle::base.html.twig' %}
{# @var search \AppBundle\Entity\Search #}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">
                    {{ search.name }}
                </h1>
            </div>
        </div>
        <div class="container-fluid">
            <div class="form-group col-lg-4">
                {{ form_widget(addCompanyForm.company, {
                    'attr': {
                        'class': 'col-lg-2',
                        'placeholder': 'form.company.title'
                    }
                }) }}
            </div>
            <div class="form-group col-lg-3">
                <a id="{{ addCompanyForm.vars.id ~ '_add' }}" href="#" class="btn btn-action btn-success">{{ 'form.submit.add'|trans({}, 'form') }}</a>
                &nbsp;|&nbsp;
                <a href="{{ path('company_create', {'search': search.id}) }}" class="btn btn-action btn-info">{{ 'form.submit.new'|trans({}, 'form') }}</a>
            </div>
        </div>
        {% for row in companies|batch(3) %}
            <div class="row">
                {% for company in row %}
                    {# @var company \AppBundle\Entity\Company #}
                    <div class="col-md-4 portfolio-item">
                        <h3>
                        {% if is_granted('IS_AUTHENTICATED_REMEMBERED') and (is_granted('ROLE_ADMIN') or is_granted('EDIT', company) or company.isOwner(app.user)) %}
                            <small><a href="{{ path('company_edit', {'id': company.id, 'search': search.id}) }}"><span class="glyphicon glyphicon-edit"></span></a></small>
                        {% endif %}
                            {{ company.name|title }} <span class="badge">{{ company.countSearchDetails() }}</span>
                            <small><a href="{{ path('search_details_create', {'id': search.id, 'company_id': company.id}) }}"><span class="glyphicon glyphicon-plus-sign text-green" data-toggle="tooltip" data-placement="right" title="Add interaction"></span></a></small>
                        </h3>
                        <div class="container-fluid" style="margin-bottom: 5px">
                            <img class="img-responsive col-lg-5" src="http://placehold.it/150x150" alt="logo {{ company.name }}">
                            <div class="address col-lg-6 col-lg-offset-1">
                                <p class="address">
                                    {% include 'AppBundle:Common:address.html.twig' with {'address': company.address} %}
                                </p>
                            </div>
                            <div class="clearfix"></div>
                        </div>

                        <div class="panel-group" id="accordion_search_{{ search.id }}" role="tablist" aria-multiselectable="true">
                        {% for detail in company.searchDetails %}
                            {# @var detail \AppBundle\Entity\Search\Details #}
                            <div class="panel panel-default">
                                <div class="panel-heading" role="tab" id="heading_search_detail_{{ detail.id }}">
                                    <h4 class="panel-title">
                                        <a role="button" data-toggle="collapse" data-parent="#accordion_search_{{ search.id }}" href="#collapse_search_detail_{{ detail.id }}" aria-expanded="true" aria-controls="collapse_search_detail_{{ detail.id }}">
                                            Le {{ detail.createdAt|localizeddate('full', 'none') }}
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapse_search_detail_{{ detail.id }}" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_search_detail_{{ detail.id }}">
                                    <div class="panel-body">
                                        {% if detail.collaborators.count > 0 %}
                                            <p>Contacts: {{ detail.collaborators|join(', ') }}</p>
                                        {% endif %}
                                        <div class="markdown well">
                                            {{ detail.description|md2html }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
{% endblock content %}

{% block foot_javascripts %}
    {{ parent() }}
    <script>
        $('#{{ addCompanyForm.company.vars.id }}').change(function () {
            var company_selected = $('#{{ addCompanyForm.company.vars.id }}').val();

            $('#{{ addCompanyForm.vars.id ~ '_add' }}').attr('href', Routing.generate('search_details_create', {
                id: '{{ search.id }}',
                company_id: company_selected
            }));
        });
        $('#{{ addCompanyForm.company.vars.id }}').change();

        $('div[role="tablist"] div[role="tabpanel"]').each(function() {
            $(this).collapse('hide');
        });

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
            $('select').select2();
        });
    </script>
{% endblock foot_javascripts %}
